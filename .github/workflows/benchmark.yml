name: JupyterLab Benchmark Tests

on:
  schedule:
    # Every Sunday at 01:12am
    - cron: "12 1 * * 0"
  workflow_dispatch:
    inputs:
      challenger:
        description: "JupyterLab Git repository with the challenger version (format {owner}/{repo})"
        required: true
      challenger_branch:
        description: "Git repository reference to the challenger branch"
        required: true
      reference_branch:
        description: "Reference branch on the JupyterLab repository (default: master)"
        required: false
        default: "master"
      browser:
        description: "Which browser to use (one of 'chromium' [default], 'firefox', 'webkit')"
        required: false
        default: "chromium"
      samples:
        description: "Number of samples to compute"
        required: false
        default: "100"
      tests:
        description: 'List of test notebooks to include (available ["codeNotebook", "mdNotebook", "largePlotly", "longOutput", "manyPlotly", "manyOutputs", "errorOutputs"])'
        required: false
        default: '["codeNotebook", "mdNotebook", "longOutput", "errorOutputs"]'
      size:
        description: "Test files size (bigger means larger test files)"
        required: false
        default: "100"

permissions:
  issues: write

jobs:
  test:
    runs-on: ubuntu-20.04

    env:
      # Which browser to use (one of 'chromium', 'firefox', 'webkit')
      BROWSER_NAME: ${{ github.event.inputs.browser || 'chromium' }}
      # How many samples to compute the statistical distribution
      BENCHMARK_NUMBER_SAMPLES: ${{ github.event.inputs.samples || '100' }}
      # How many times to switch between each tabs
      BENCHMARK_SWITCHES: 3
      # The test notebook size
      BENCHMARK_MAX_N: ${{ github.event.inputs.size || '100' }}
      # Notebooks to test
      BENCHMARK_NOTEBOOKS: ${{ github.event.inputs.tests || '["codeNotebook", "mdNotebook", "longOutput", "errorOutputs"]' }}

      # Repository to clone for scheduled benchmark
      CHALLENGER_REPOSITORY: ${{ github.event.inputs.challenger || 'jupyterlab/jupyterlab' }}
      # Branch to checkout for scheduled benchmark
      CHALLENGER_REF: ${{ github.event.inputs.challenger_branch || 'master' }}

      REFERENCE_BRANCH: ${{ github.event.inputs.reference_branch || 'master' }}

    steps:
      - name: Run benchmark
        uses: ./.github/workflows/run-jupyterlab
        with:
          event: ${{ github.event_name }}
          challenger: ${{ env.CHALLENGER_REPOSITORY }}
          challenger_branch: ${{ env.CHALLENGER_REPOSITORY }}
          reference_branch: ${{ env.REFERENCE_BRANCH }}
          browser: ${{ env.BROWSER_NAME }}
          samples: ${{ env.BENCHMARK_NUMBER_SAMPLES }}
          tests: ${{ env.BENCHMARK_NOTEBOOKS }}
          size: ${{ env.BENCHMARK_MAX_N }}
